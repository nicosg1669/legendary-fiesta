# â”€â”€â”€ BLOQUE 4: Reporte y envÃ­o por correo â€” Jaime M. Actualizacion
echo -e "\n${BOLD}${CYAN}===== BLOQUE 4: REPORTE Y ENVÃO POR CORREO â€” Jaime M. =====${NC}"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
REPORTE="reporte_${IP}_${TIMESTAMP}.txt"

echo -e "ğŸ“„ Generando reporte en ${REPORTE}â€¦"
{
  echo "===== REPORTE DE ANÃLISIS DE IP ====="
  echo "IP: $IP"
  echo "Fecha: $(date)"

  echo ""
  echo "ğŸŒ GEO: $GEO"
  echo ""
  echo "ğŸ§¾ WHOIS RDAP: CIDR=$CIDR, NetName=$NETNM, Country=$CTRY2"

  echo ""
  echo -n "ğŸ“› DNSBLs ($count): "
  if (( count>0 )); then
    printf "%s " "${listed[@]}"
  else
    echo -n "Ninguna"
  fi

  echo ""
  echo "ğŸ›¡ AbuseIPDB: $score% â€” $reports reportes â€” uso: $usage â€” paÃ­s: $ctry"

  echo ""
  echo "ğŸ¢ Shodan Org: $sh_org"
  echo "ğŸ’» Shodan SO:  $sh_os"
  echo "ğŸ” Puertos Shodan: ${sh_ports:-Ninguno}"

  echo ""
  echo "ğŸ”“ Puertos abiertos (Nmap): $PORTS"

  echo ""
  echo "ğŸš¨ Riesgo Avanzado: $lvl â€” $msg"
} > "$REPORTE"

echo -e "âœ… Reporte guardado como ${GREEN}$REPORTE${NC}"

# Forzamos remitente para que coincida con cuenta autenticada
FROM="carlos.ramirez105@inacapmail.cl"
TO="nicolas.montero@inacapmail.cl"

echo -e "ğŸ“¬ Enviando reporte automÃ¡ticamente a: ${TO}"
echo "Adjunto el reporte de la IP analizada ($IP)." \
  | mail -r "$FROM" -s "Reporte IP $IP" -A "$REPORTE" "$TO"

echo -e "ğŸ“§ Reporte enviado correctamente a ${GREEN}${TO}${NC}"
echo -e "\n${BOLD}${CYAN}ğŸš€ ANÃLISIS COMPLETO FINALIZADO ğŸš€${NC}"
